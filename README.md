
Сервис "Анти-брутфорс"
=====================
Общее описание
---------------
* Сервис предназначен для борьбы с подбором паролей при авторизации в какой-либо системе.
* Сервис вызывается перед авторизацией пользователя и может либо разрешить, либо заблокировать попытку.
* Предполагается, что сервис используется только для server-server, т.е. скрыт от конечного пользователя.

Алгоритм работы
---------------

Сервис ограничивает частоту попыток авторизации для различных комбинаций параметров, например:
* не более N = 10 попыток в минуту для данного логина.
* не более M = 100 попыток в минуту для данного пароля (защита от обратного brute-force).
* не более K = 1000 попыток в минуту для данного IP (число большое, т.к. NAT).

Для подсчета и ограничения частоты запросов, можно использовать например алгоритм leaky bucket. Или иные аналогичные: https://ru.wikipedia.org/wiki/Алгоритм_текущего_ведра

Сервис будет поддерживать множество bucket-ов, по одному на каждый логин/пароль/ip.

Bucket-ы хранятся в Redis.

White/black листы содержат списки адресов сетей, которые обрабатываются более простым способом:
* Если входящий IP в whitelist, то сервис безусловно разрешает авторизацию (isBruteforce=no);
* Если - в blacklist, то безусловно отклоняет (isBruteforce=yes).

White/black листы хранятся в postgresql.

Архитектура
-----------

Микросервис состоит из API, конфигурационного файла для хранения настроек, базы данных для black/white списков, хранилища для bucket'ов. Сервис предоставляет интерфейсы gRPC и REST API.

Реализация на Spring Framework. Для работы с postgresql используется spring data jdbc, для redis - spring data redis.

Описание методов API
--------------------

### Проверка на брутфорс (isBruteforce)

Запрос:
* login
* password
* ip

Ответ:
* yes/no - сервис должен возвращать no, если считает что запрос нормальный и yes, если считает что происходит bruteforce.

### Сброс bucket (dropBucket)

Должен очистить bucket-ы соответствующие переданным login и ip.
* login
* ip

### Добавление IP в blacklist (addIpToBlacklist)
* подсеть (IP + маска или только IP), пример: 192.1.1.0/25 или 192.1.1.1

### Удаление IP из blacklist (dropIpFromBlacklist)
* подсеть (IP + маска или только IP)

### Добавление IP в whitelist (addIpToWhitelist)
* подсеть (IP + маска или только IP)

### Удаление IP из whitelist (dropIpFromWhitelist)
* подсеть (IP + маска или только IP)

_____
### Детали реализации

Проверяются адреса только в формате IPv4

Пример подсети: 192.1.1.0/25 - представляет собой адрес 192.1.1.0 с маской 255.255.255.128

Во время работы сервиса при поступлении очередного IP мы проходимся по подсетям в черных и белых списках и вычисляем, принадлежит ли IP одной из них.
Для быстродействия black/white листы периодически кешируются и по истечении определенного времени вычитываются снова, например раз в 10 минут.

### Конфигурация

Основные параметры конфигурации: 
* N, M, K - лимиты (количество в минуту) по достижении которых, сервис считает попытку брутфорсом,
* T1, T2 - период кэширования, время отсчитывается от момента завершения последнего кэширования

### Тестирование

Написаны юнит-тесты и интеграционные тесты, которые проверяют отдельно слои репозиториев, сервисов, rest api, gRPC api.
