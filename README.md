
Сервис "Анти-брутфорс"
=====================
Общее описание
* Сервис предназначен для борьбы с подбором паролей при авторизации в какой-либо системе.
* Сервис вызывается перед авторизацией пользователя и может либо разрешить, либо заблокировать попытку.
* Предполагается, что сервис используется только для server-server, т.е. скрыт от конечного пользователя.

Алгоритм работы

Сервис ограничивает частоту попыток авторизации для различных комбинаций параметров, например:
* не более N = 10 попыток в минуту для данного логина.
* не более M = 100 попыток в минуту для данного пароля (защита от обратного brute-force).
* не более K = 1000 попыток в минуту для данного IP (число большое, т.к. NAT).

Для подсчета и ограничения частоты запросов, можно использовать например алгоритм leaky bucket. Или иные аналогичные: https://ru.wikipedia.org/wiki/Алгоритм_текущего_ведра

Сервис будет поддерживать множество bucket-ов, по одному на каждый логин/пароль/ip.

Bucket-ы предполагается хранить в Redis.

White/black листы содержат списки адресов сетей, которые обрабатываются более простым способом:
* Если входящий IP в whitelist, то сервис безусловно разрешает авторизацию (ok=true);
* Если - в blacklist, то безусловно отклоняет (ok=false).

White/black листы предполагается хранить в postgresql.

Архитектура

Микросервис состоит из API, конфигурационного файла для хранения настроек, базы данных для black/white списков, хранилища для bucket'ов. Сервис должен предоставлять gRPC или REST API.

Описание методов API

Проверка на брутфорс

Запрос:
* login
* password
* ip

Ответ:
* yes/no - сервис должен возвращать no, если считает что запрос нормальный и yes, если считает что происходит bruteforce.

Сброс bucket

Должен очистить bucket-ы соответствующие переданным login и ip.
* login
* ip

Добавление IP в blacklist
* подсеть (IP + маска)

Удаление IP из blacklist
* подсеть (IP + маска)

Добавление IP в whitelist
* подсеть (IP + маска)

Удаление IP из whitelist
* подсеть (IP + маска)


Достаточно IPv4

Пример подсети: 192.1.1.0/25 - представляет собой адрес 192.1.1.0 с маской 255.255.255.128

Во время работы сервиса при поступлении очередного IP мы проходимся по подсетям в черных и белых списках и вычисляем, принадлежит ли IP одной из них.
Для быстродействия black/white листы предполагается периодически кешировать и по истечении определенного времени вычитывать их снова, например раз в 10 минут.

Конфигурация

Основные параметры конфигурации: N, M, K - лимиты по достижению которых, сервис считает попытку брутфорсом.
